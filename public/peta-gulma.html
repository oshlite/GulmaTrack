<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Status Gulma - GulmaTrack</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #128241;
            --secondary-color: #155A31;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.15);
            --border-color: #999999;
            --bg-light: #f0f2f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins';
            background: var(--bg-light);
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .controls {
            background: white;
            border: 1px solid var(--border-color);
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        button:active {
            transform: translateY(0);
        }
        select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background: white;
            flex: 1;
            min-width: 150px;
        }
        .map-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
            margin-bottom: 30px;
        }
        #map {
            width: 100%;
            height: 600px;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            z-index: 1000;
            min-width: 200px;
        }
        .legend h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 600;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .leaflet-popup-content {
            margin: 0 !important;
            font-family: 'Poppins';
        }
        .leaflet-popup-content h3 {
            color: var(--primary-color);
            font-size: 16px;
            margin-bottom: 10px;
        }
        .leaflet-popup-content img {
            max-width: 100%;
            border-radius: 8px 8px 0 0;
        }
        .leaflet-popup-content table {
            font-size: 13px;
        }
        .leaflet-tooltip {
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            padding: 8px 12px !important;
            font-family: 'Poppins';
        }
        .leaflet-tooltip-top:before {
            border-top-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <select id="wilayahSelect">
                <option value="">-- Pilih Wilayah --</option>
            </select>
            <button onclick="loadWilayah()"><i class="fas fa-search"></i> Tampilkan Peta</button>
            <button onclick="loadAllWilayah()" style="background-color: #128241;"><i class="fas fa-globe"></i> Semua Wilayah</button>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="legend">
                <h4><i class="fas fa-info-circle"></i> Status Gulma</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #22c55e;"></div>
                    <span><strong>Bersih</strong></span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #eab308;"></div>
                    <span><strong>Ringan</strong></span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f97316;"></div>
                    <span><strong>Sedang</strong></span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span><strong>Berat</strong></span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9ca3af;"></div>
                    <span><strong>Tidak ada Data</strong></span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let layers = {};

        // Initialize map on page load
        function initMap() {
            map = L.map('map').setView([-4.85, 105.0], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }).addTo(map);
            
            console.log('‚úì Map initialized');
        }

        // Color mapping untuk kategori (akan di-load dari API)
        let kategoriColors = {
            'Bersih': '#22c55e',
            'Ringan': '#eab308',
            'Sedang': '#f97316',
            'Berat': '#ef4444'
        };

        // Get feature style based on kategori dari CSV
        function getFeatureStyle(feature) {
            const props = feature.properties || {};
            let color = '#9ca3af'; // Default: tidak ada data (gray-400)
            let borderColor = '#6b7280'; // Border gray-500
            
            // Ambil kategori dari properties (dari CSV)
            const kategori = props.kategori || props.Kelas_weed || props.gulma_KATEGORI || props.Status || '';
            
            // Cari warna dari mapping
            if (kategori && kategoriColors[kategori]) {
                color = kategoriColors[kategori];
                borderColor = kategoriColors[kategori];
            }

            return {
                color: borderColor,
                weight: 2,
                opacity: 0.9,
                fillColor: color,
                fillOpacity: 0.6
            };
        }

        // Create tooltip content for hover (quick info)
        function createTooltip(props) {
            const kategori = props.kategori || props.Kelas_weed || props.gulma_KATEGORI || 'Tidak Ada Data';
            const lokasi = props.seksi || props.Lokasi || props.id_feature || 'N/A';
            
            return `<div style="font-family: 'Poppins'; font-size: 13px; padding: 5px;">
                <strong>üìç Kode Lokasi:</strong> ${lokasi}<br>
                <strong>Status Gulma:</strong> <span style="color: ${kategoriColors[kategori] || '#9ca3af'}; font-weight: bold;">${kategori}</span>
            </div>`;
        }

        // Create popup content
        function createPopup(props) {
            const kategori = props.kategori || props.Kelas_weed || props.gulma_KATEGORI || 'Tidak Ada Data';
            let statusColor = kategoriColors[kategori] || '#9ca3af';
            let textColor = 'white';
            
            // Kuning perlu text hitam untuk keterbacaan
            if (kategori === 'Sedang') {
                textColor = '#1f2937';
            }

            let html = '<div style="min-width: 300px; padding: 0;">';
            
            // Foto placeholder
            html += `<div style="width: 100%; height: 200px; border-radius: 8px 8px 0 0; overflow: hidden; margin-bottom: 10px;">
                <img src="/image/roblox.png" alt="Foto Lokasi" style="width: 100%; height: 100%; object-fit: cover;">
            </div>`;
            
            // Content wrapper
            html += '<div style="padding: 10px;">';
            
            // Tampilkan info seksi/lokasi
            const lokasi = props.seksi || props.Lokasi || props.id_feature;
            if (lokasi) {
                html += `<h3 style="margin: 0 0 10px 0; color: #128241; font-size: 16px;">üìç Seksi ${lokasi}</h3>`;
            }
            
            // Tampilkan info PG dan FM
            if (props.pg) {
                html += `<div style="font-size: 12px; color: #6b7280; margin-bottom: 10px;">PG: ${props.pg} | FM: ${props.fm || '-'}</div>`;
            }
            
            html += `<div style="background: ${statusColor}; color: ${textColor}; padding: 8px; margin-bottom: 15px; border-radius: 4px; text-align: center; font-weight: bold;">
                ${kategori}
            </div>`;
            
            html += '<table style="width: 100%; font-size: 13px; margin-bottom: 10px;">';
            
            if (props.Wilayah || props.gulma_Wilayah) {
                html += `<tr><td style="padding: 5px 0;"><strong>Wilayah:</strong></td><td style="padding: 5px 0; text-align: right;">${props.Wilayah || props.gulma_Wilayah}</td></tr>`;
            }
            
            const bruto = props.Luas_Bruto || props.Bruto;
            if (bruto) {
                html += `<tr><td style="padding: 5px 0;"><strong>Luas Bruto:</strong></td><td style="padding: 5px 0; text-align: right;">${bruto} Ha</td></tr>`;
            }
            
            // Data dari CSV
            if (props.neto) {
                html += `<tr><td style="padding: 5px 0;"><strong>Neto:</strong></td><td style="padding: 5px 0; text-align: right;">${props.neto} Ha</td></tr>`;
            }
            
            if (props.hasil) {
                html += `<tr><td style="padding: 5px 0;"><strong>Hasil:</strong></td><td style="padding: 5px 0; text-align: right;">${props.hasil}</td></tr>`;
            }
            
            if (props.umur_tanaman) {
                html += `<tr><td style="padding: 5px 0;"><strong>Umur Tanaman:</strong></td><td style="padding: 5px 0; text-align: right;">${props.umur_tanaman} bulan</td></tr>`;
            }
            
            if (props.penanggungjawab) {
                html += `<tr><td style="padding: 5px 0;"><strong>Penanggung Jawab:</strong></td><td style="padding: 5px 0; text-align: right;">${props.penanggungjawab}</td></tr>`;
            }
            
            if (props.activitas) {
                html += `<tr><td style="padding: 5px 0;"><strong>Aktivitas:</strong></td><td style="padding: 5px 0; text-align: right;">${props.activitas}</td></tr>`;
            }
            
            if (props.total_tk) {
                html += `<tr><td style="padding: 5px 0;"><strong>Total TK:</strong></td><td style="padding: 5px 0; text-align: right;">${props.total_tk} TK</td></tr>`;
            }
            
            if (props.tk_ha) {
                html += `<tr><td style="padding: 5px 0;"><strong>TK/Ha:</strong></td><td style="padding: 5px 0; text-align: right;">${props.tk_ha}</td></tr>`;
            }
            
            if (props.tanggal) {
                html += `<tr><td style="padding: 5px 0;"><strong>Tanggal:</strong></td><td style="padding: 5px 0; text-align: right;">${props.tanggal}</td></tr>`;
            }
            
            html += '</table>';
            html += '</div></div>';
            return html;
        }

        // Load single wilayah
        function loadWilayah() {
            const wilayahNum = document.getElementById('wilayahSelect').value;
            if (!wilayahNum) {
                alert('Silakan pilih wilayah terlebih dahulu');
                return;
            }

            clearMap();
            console.log(`Loading Wilayah ${wilayahNum}...`);

            fetch(`/api/wilayah/geojson/${wilayahNum}`)
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    const layer = L.geoJSON(data, {
                        style: getFeatureStyle,
                        onEachFeature: (feature, layer) => {
                            if (feature.properties) {
                                layer.bindPopup(createPopup(feature.properties));
                                layer.bindTooltip(createTooltip(feature.properties), {
                                    permanent: false,
                                    sticky: true,
                                    direction: 'top',
                                    offset: [0, -10]
                                });
                            }
                        }
                    }).addTo(map);
                    
                    layers[wilayahNum] = layer;
                    
                    const bounds = layer.getBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    
                    console.log(`‚úì Loaded ${data.features.length} features for Wilayah ${wilayahNum}`);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Gagal memuat data: ' + error.message);
                });
        }

        // Load all wilayah
        function loadAllWilayah() {
            clearMap();
            console.log('Loading all wilayah...');

            fetch('/api/wilayah/data')
                .then(r => r.json())
                .then(summary => {
                    const wilayahNumbers = summary.data.map(w => w.wilayah);
                    const promises = wilayahNumbers.map(num => 
                        fetch(`/api/wilayah/geojson/${num}`)
                            .then(r => r.json())
                            .then(data => ({ wilayah: num, data }))
                    );

                    return Promise.all(promises);
                })
                .then(results => {
                    const allBounds = [];
                    let totalFeatures = 0;

                    results.forEach(({ wilayah, data }) => {
                        if (data.features && data.features.length > 0) {
                            const layer = L.geoJSON(data, {
                                style: getFeatureStyle,
                                onEachFeature: (feature, layer) => {
                                    if (feature.properties) {
                                        layer.bindPopup(createPopup(feature.properties));
                                        layer.bindTooltip(createTooltip(feature.properties), {
                                            permanent: false,
                                            sticky: true,
                                            direction: 'top',
                                            offset: [0, -10]
                                        });
                                    }
                                }
                            }).addTo(map);

                            layers[wilayah] = layer;
                            totalFeatures += data.features.length;
                            
                            const bounds = layer.getBounds();
                            if (bounds.isValid()) {
                                allBounds.push(bounds);
                            }
                        }
                    });

                    if (allBounds.length > 0) {
                        const combinedBounds = allBounds.reduce((acc, bounds) => {
                            return acc.extend(bounds);
                        }, L.latLngBounds(allBounds[0]));
                        
                        map.fitBounds(combinedBounds, { padding: [50, 50] });
                    }

                    console.log(`‚úì Loaded ${results.length} wilayah, ${totalFeatures} total features`);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Gagal memuat data: ' + error.message);
                });
        }

        // Clear map
        function clearMap() {
            Object.values(layers).forEach(layer => {
                if (map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
            layers = {};
            console.log('‚úì Map cleared');
        }

        // Load statistics and populate dropdown
        function loadStats() {
            fetch('/api/wilayah/data')
                .then(r => r.json())
                .then(data => {
                    // Update stats
                    document.getElementById('totalWilayah').textContent = data.total_wilayah;
                    
                    let totalArea = 0;
                    let totalPlot = 0;
                    data.data.forEach(w => {
                        totalArea += w.total_area;
                        totalPlot += w.feature_count;
                    });
                    
                    document.getElementById('totalArea').textContent = totalArea.toFixed(2);
                    document.getElementById('totalPlot').textContent = totalPlot;

                    // Populate dropdown
                    const select = document.getElementById('wilayahSelect');
                    data.data.forEach(wilayah => {
                        const option = document.createElement('option');
                        option.value = wilayah.wilayah;
                        option.textContent = `Wilayah ${wilayah.wilayah} (${wilayah.feature_count} plot, ${wilayah.total_area} Ha)`;
                        select.appendChild(option);
                    });

                    console.log('‚úì Stats loaded');
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // Load kategori colors from API
        function loadKategoriColors() {
            fetch('/api/kategori-colors')
                .then(r => r.json())
                .then(response => {
                    if (response.success && response.data) {
                        kategoriColors = response.data;
                        console.log('‚úì Kategori colors loaded:', kategoriColors);
                    }
                })
                .catch(error => {
                    console.warn('Failed to load kategori colors, using defaults:', error);
                });
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing GulmaTrack Map...');
            loadKategoriColors();
            initMap();
            loadStats();
            // Auto-load all wilayah on start
            setTimeout(() => loadAllWilayah(), 500);
        });
    </script>
</body>
</html>
