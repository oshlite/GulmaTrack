<!DOCTYPE html>
<html>
<head>
    <title>GulmaTrack Map - Comprehensive Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1, h2 { color: #197B40; }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #197B40;
            border-radius: 4px;
        }
        #map {
            width: 100%;
            height: 500px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        button {
            background: #197B40;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-size: 14px;
        }
        button:hover {
            background: #155A31;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .data-list {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .data-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .data-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GulmaTrack Map - Comprehensive Test</h1>
        
        <div class="section">
            <h2>1. System Status</h2>
            <div id="systemStatus"></div>
            <button onclick="checkSystem()">Check System</button>
        </div>

        <div class="section">
            <h2>2. API Endpoints Test</h2>
            <button onclick="testWilayahData()">Test /api/wilayah/data</button>
            <button onclick="testGeojsonAPI(16)">Test Wilayah 16</button>
            <button onclick="testGeojsonAPI(17)">Test Wilayah 17</button>
            <div id="apiStatus"></div>
        </div>

        <div class="section">
            <h2>3. Map Rendering Test</h2>
            <div id="mapStatus"></div>
            <div id="map"></div>
            <button onclick="initMapTest()">Initialize Map</button>
            <button onclick="loadAllWilayahTest()">Load All Wilayah</button>
            <button onclick="loadWilayahTest(16)">Load Wilayah 16</button>
            <button onclick="loadWilayahTest(17)">Load Wilayah 17</button>
        </div>

        <div class="section">
            <h2>4. Data Summary</h2>
            <div id="dataSummary"></div>
        </div>

        <div class="section">
            <h2>5. Console Output</h2>
            <div id="consoleLogs" class="data-list"></div>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let layers = {};
        const logs = [];
        
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${msg}`;
            logs.push({ message: logEntry, type });
            
            const logsDiv = document.getElementById('consoleLogs');
            const div = document.createElement('div');
            div.className = `data-item ${type}`;
            div.textContent = logEntry;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLogs() {
            logs.length = 0;
            document.getElementById('consoleLogs').innerHTML = '';
            log('Logs cleared', 'info');
        }

        function setStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="status ${type}">${message}</div>`;
            log(message, type);
        }

        function checkSystem() {
            let html = '<div class="status info">';
            html += `<p>Leaflet: ${typeof L !== 'undefined' ? '✓ Loaded' : '✗ Not loaded'}</p>`;
            html += `<p>Fetch API: ${typeof fetch !== 'undefined' ? '✓ Available' : '✗ Not available'}</p>`;
            html += `<p>DOM Ready: ${document.readyState}</p>`;
            html += `<p>Map Element: ${document.getElementById('map') ? '✓ Found' : '✗ Not found'}</p>`;
            html += '</div>';
            document.getElementById('systemStatus').innerHTML = html;
        }

        function testWilayahData() {
            log('Testing /api/wilayah/data...', 'info');
            setStatus('apiStatus', 'Testing...', 'info');

            fetch('/api/wilayah/data')
                .then(r => {
                    log(`Response: HTTP ${r.status}`, r.ok ? 'success' : 'error');
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    log(`Loaded ${data.data.length} wilayah`, 'success');
                    let html = '<div class="status success">';
                    html += `<p>✓ Wilayah Count: ${data.data.length}</p>`;
                    html += `<p>Total CRS: ${data.crs}</p>`;
                    data.data.forEach(w => {
                        html += `<p>  - Wilayah ${w.wilayah}: ${w.feature_count} plots, ${w.total_area} Ha</p>`;
                    });
                    html += '</div>';
                    document.getElementById('dataSummary').innerHTML = html;
                })
                .catch(e => {
                    const msg = `✗ Error: ${e.message}`;
                    log(msg, 'error');
                    setStatus('apiStatus', msg, 'error');
                });
        }

        function testGeojsonAPI(wilayah) {
            log(`Testing /api/wilayah/geojson/${wilayah}...`, 'info');
            setStatus('apiStatus', `Testing Wilayah ${wilayah}...`, 'info');

            fetch(`/api/wilayah/geojson/${wilayah}`)
                .then(r => {
                    log(`Response: HTTP ${r.status}`, r.ok ? 'success' : 'error');
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    log(`Loaded ${data.features.length} features for Wilayah ${wilayah}`, 'success');
                    const msg = `✓ Wilayah ${wilayah}: ${data.features.length} features, CRS: ${data.crs ? data.crs.properties.name : 'unknown'}`;
                    setStatus('apiStatus', msg, 'success');
                })
                .catch(e => {
                    const msg = `✗ Error: ${e.message}`;
                    log(msg, 'error');
                    setStatus('apiStatus', msg, 'error');
                });
        }

        function initMapTest() {
            log('Initializing map...', 'info');
            if (map) {
                log('Map already exists', 'info');
                return;
            }
            
            map = L.map('map').setView([-4.7, 108.2], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            log('Map initialized at [-4.7, 108.2], zoom 11', 'success');
            setStatus('mapStatus', '✓ Map initialized', 'success');
        }

        function loadWilayahTest(wilayah) {
            if (!map) {
                log('Map not initialized', 'error');
                setStatus('mapStatus', '✗ Map not initialized', 'error');
                return;
            }

            log(`Loading Wilayah ${wilayah}...`, 'info');
            setStatus('mapStatus', `Loading Wilayah ${wilayah}...`, 'info');

            fetch(`/api/wilayah/geojson/${wilayah}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    // Remove old layer
                    if (layers[wilayah]) {
                        map.removeLayer(layers[wilayah]);
                    }

                    // Add layer
                    const layer = L.geoJSON(data, {
                        style: {
                            color: '#3498db',
                            weight: 2,
                            opacity: 0.8,
                            fillOpacity: 0.6
                        }
                    }).addTo(map);

                    layers[wilayah] = layer;
                    
                    // Fit bounds
                    const bounds = layer.getBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    
                    log(`Loaded ${data.features.length} features for Wilayah ${wilayah}`, 'success');
                    setStatus('mapStatus', `✓ Wilayah ${wilayah} loaded (${data.features.length} features)`, 'success');
                })
                .catch(e => {
                    const msg = `✗ Error loading Wilayah ${wilayah}: ${e.message}`;
                    log(msg, 'error');
                    setStatus('mapStatus', msg, 'error');
                });
        }

        function loadAllWilayahTest() {
            if (!map) {
                log('Map not initialized', 'error');
                setStatus('mapStatus', '✗ Map not initialized', 'error');
                return;
            }

            log('Loading all wilayah...', 'info');
            setStatus('mapStatus', 'Loading all wilayah...', 'info');

            const wilayahNumbers = [16, 17, 18, 19, 20, 21, 22, 23];
            let loadedCount = 0;
            let totalFeatures = 0;

            wilayahNumbers.forEach(num => {
                fetch(`/api/wilayah/geojson/${num}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.features && data.features.length > 0) {
                            const layer = L.geoJSON(data, {
                                style: {
                                    color: '#3498db',
                                    weight: 2,
                                    opacity: 0.8,
                                    fillOpacity: 0.6
                                }
                            }).addTo(map);
                            
                            layers[num] = layer;
                            totalFeatures += data.features.length;
                            log(`Wilayah ${num}: ${data.features.length} features`, 'success');
                        }
                        
                        loadedCount++;
                        if (loadedCount === wilayahNumbers.length) {
                            let bounds = L.latLngBounds();
                            Object.values(layers).forEach(layer => {
                                try {
                                    const b = layer.getBounds();
                                    if (b && b.isValid()) bounds.extend(b);
                                } catch (e) {}
                            });
                            
                            if (bounds.isValid()) {
                                map.fitBounds(bounds, { padding: [50, 50] });
                            }
                            
                            const msg = `✓ All wilayah loaded (${totalFeatures} total features)`;
                            log(msg, 'success');
                            setStatus('mapStatus', msg, 'success');
                        }
                    })
                    .catch(e => {
                        log(`Error loading Wilayah ${num}: ${e.message}`, 'error');
                        loadedCount++;
                    });
            });
        }

        // Auto-run checks on load
        window.addEventListener('load', () => {
            log('Page loaded', 'info');
            checkSystem();
        });
    </script>
</body>
</html>
